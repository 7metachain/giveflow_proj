# GiveFlow 存款和支取功能测试指南

## 🎯 新增功能概述

测试页面现在包含了完整的资金流向测试功能：

### 资金流向
```
捐赠 → CampaignRegistry → MilestoneVault (存款) → 凭证审核 → MilestoneVault (提款) → 项目受益人
```

---

## 🚀 完整测试流程

### 步骤 1: 创建项目并接受捐赠

1. **切换到 "📋 项目管理" Tab**
2. 创建一个新项目（目标金额：1 MON）
3. 向项目捐赠 0.5 MON

**验证**: 项目的 `raisedAmount` 应该增加到 0.5 MON

---

### 步骤 2: 向 MilestoneVault 存款 ⭐ 新功能

1. **切换到 "🎯 里程碑" Tab**
2. 找到 "💰 向保险库存款" 面板
3. 输入：
   - **项目 ID**: 1
   - **存款金额**: 0.01 MON
4. 点击 "💰 存入保险库"
5. 在钱包中确认交易

**验证**: 右侧 "💰 项目余额" 面板应该显示 0.01 MON

**说明**:
- 这一步将资金从你的钱包存入 MilestoneVault 合约
- 存款的资金会记录在项目的 `campaignBalance` 中
- 这些资金后续可以通过凭证提取

---

### 步骤 3: 创建里程碑

1. 在 "🎯 里程碑" Tab 中
2. 找到 "🎯 创建里程碑" 面板
3. 输入：
   - **项目 ID**: 1
   - **标题**: 第一阶段 - 采购医疗设备
   - **目标金额**: 0.3 MON
   - **需要凭证验证**: ✅ 勾选
4. 点击 "🎯 创建里程碑"

**验证**: 里程碑总数应该增加

---

### 步骤 4: 提交凭证

1. **切换到 "🔍 凭证管理" Tab**
2. 找到 "📤 提交凭证" 面板
3. 输入：
   - **项目 ID**: 1
   - **里程碑 ID**: 1
   - **申请金额**: 0.1 MON
   - **IPFS URI**: `ipfs://QmTest123`
4. 点击 "📤 提交凭证"

**验证**:
- 凭证总数增加
- 查询凭证，状态应该为 "待审核"

---

### 步骤 5: 查询支取记录 ⭐ 新功能

1. 在 "🎯 里程碑" Tab 中
2. 找到 "🔍 查询支取记录" 面板
3. 输入 **支取记录 ID**: 1
4. 点击 "查询支取记录"

**验证**: 右侧会显示支取记录详情（如果有支取记录的话）

**支取记录包含**:
- 支取 ID
- 项目 ID
- 里程碑 ID
- 凭证 ID
- 接收者地址
- 支取金额
- 支取时间
- 交易哈希

---

## 💡 完整的资金流向测试场景

### 场景: 端到端的捐赠到提款流程

#### 第一步: 项目创建和捐赠
```
1. 创建项目 (目标: 1 MON)
2. 捐赠 0.5 MON 到项目
   → 项目状态: raisedAmount = 0.5 MON
```

#### 第二步: 资金进入保险库
```
3. 向 MilestoneVault 存款 0.3 MON
   → 项目余额: campaignBalance = 0.3 MON
   → 这些资金可以用于里程碑提款
```

#### 第三步: 创建里程碑并提交凭证
```
4. 创建里程碑 (目标: 0.2 MON, 需要凭证)
5. 提交凭证 (申请: 0.1 MON)
   → 凭证状态: 待审核
```

#### 第四步: 凭证审核（需要授权的审核员）
```
6. 使用 recordAIReview 或 recordManualReview 审核凭证
   → 凭证状态变为: AI 审核通过
```

#### 第五步: 凭证提款
```
7. 使用凭证提取资金
   → 从 MilestoneVault 转账 0.1 MON 到受益人
   → 里程碑已释放金额: releasedAmount = 0.1 MON
   → 项目余额减少: campaignBalance -= 0.1 MON
   → 创建支取记录
```

#### 第六步: 查询支取记录
```
8. 查询支取记录详情
   → 验证支取金额、接收者、时间等信息
```

---

## 🔍 各个功能面板说明

### 1. 💰 向保险库存款

**功能**: 将资金存入 MilestoneVault 合约

**参数**:
- 项目 ID: 要存入的项目
- 存款金额: 要存入的 MON 数量

**结果**:
- 资金从你的钱包转移到 MilestoneVault
- 项目的 `campaignBalance` 增加
- 触发 `FundsDeposited` 事件

**用途**:
- 为后续的里程碑提款准备资金
- 确保资金安全存储在智能合约中

---

### 2. 💸 提取资金（凭证提款）

**功能**: 使用审核通过的凭证提取资金

**参数**:
- 项目 ID
- 里程碑 ID
- 凭证 ID

**条件**:
- 凭证必须审核通过（AI 审核通过或人工审核通过）
- 项目余额充足
- 里程碑未完成
- 凭证的申请金额不超过里程碑目标

**结果**:
- 资金从 MilestoneVault 转账到凭证提交者
- 里程碑的 `releasedAmount` 增加
- 项目的 `campaignBalance` 减少
- 创建支取记录
- 如果达到目标，里程碑状态变为"已完成"

---

### 3. 🔍 查询支取记录

**功能**: 查看特定支取记录的详细信息

**参数**:
- 支取记录 ID

**返回信息**:
- 支取 ID
- 关联的项目 ID
- 关联的里程碑 ID
- 使用的凭证 ID
- 接收者地址
- 支取金额
- 支取时间戳
- 交易哈希

**用途**:
- 审计和追踪资金流向
- 验证提款操作的完整性
- 查看历史支取记录

---

## 📊 数据验证检查清单

测试完成后，验证以下数据：

### 项目状态
- [ ] 项目已筹金额正确（CampaignRegistry）
- [ ] 项目捐赠人数正确
- [ ] 项目状态为活跃

### MilestoneVault 余额
- [ ] 项目余额正确（存款 - 提款）
- [ ] 里程碑目标金额正确
- [ ] 里程碑已释放金额正确

### 凭证状态
- [ ] 凭证审核状态正确
- [ ] 凭证金额正确
- [ ] 凭证关联的项目和里程碑正确

### 支取记录
- [ ] 支取记录创建成功
- [ ] 支取金额正确
- [ ] 接收者地址正确
- [ ] 时间戳正确
- [ ] 交易哈希有效

---

## 🐛 常见问题

### Q1: 存款后项目余额没有增加

**原因**: 交易可能失败或未确认

**解决方法**:
1. 检查操作日志中的错误信息
2. 在 Explorer 查看交易状态
3. 确认钱包余额充足
4. 刷新项目余额（重新查询）

### Q2: 凭证提款失败 "Proof not approved"

**原因**: 凭证未通过审核

**解决方法**:
1. 查询凭证状态
2. 确保证状状态为 "AI 审核通过" 或 "人工审核通过"
3. 如果状态为 "待审核"，需要先进行审核（需要授权的审核员地址）

### Q3: 提款失败 "Insufficient balance"

**原因**: 项目余额不足

**解决方法**:
1. 向 MilestoneVault 存入更多资金
2. 或者减少凭证申请金额
3. 检查项目余额是否正确显示

### Q4: 查询支取记录显示 "N/A"

**原因**: 支取记录 ID 不存在

**解决方法**:
1. 检查支取记录总数
2. 使用有效的支取记录 ID
3. 如果还没有支取记录，先执行一次提款操作

### Q5: 里程碑状态没有更新

**原因**: 可能需要手动刷新

**解决方法**:
1. 点击"查询凭证"刷新里程碑信息
2. 检查已释放金额是否达到目标
3. 如果达到目标，状态应该自动变为"已完成"

---

## 🎓 下一步

完成基础测试后，你可以：

1. **测试多阶段提款**: 创建多个里程碑，逐步提款
2. **测试部分提款**: 申请金额小于目标金额的情况
3. **测试余额管理**: 多次存款，多次提款
4. **测试支取记录**: 查看所有历史支取记录
5. **集成 AI 审核**: 实现真实的 AI 审核功能

---

## 📝 测试示例数据

### 快速测试数据

```
项目:
- 标题: 测试医疗项目
- 目标: 1 MON
- 类别: medical

存款:
- 金额: 0.1 MON

里程碑:
- 标题: 第一阶段
- 目标: 0.05 MON
- 需要凭证: 是

凭证:
- 项目 ID: 1
- 里程碑 ID: 1
- 金额: 0.01 MON
- IPFS: ipfs://QmTest123
```

使用这些数据可以快速完成一次完整的测试流程。

---

祝测试顺利！🎉
